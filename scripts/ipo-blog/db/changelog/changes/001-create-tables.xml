<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.19.xsd">

    <changeSet id="001-1" author="ipo-blog-system">
        <comment>Create ipo_info table</comment>
        <createTable tableName="ipo_info">
            <column name="id" type="INT" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="stock_code" type="VARCHAR(10)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="company_name" type="VARCHAR(100)">
                <constraints nullable="false"/>
            </column>
            <column name="market_type" type="VARCHAR(20)"/>
            <column name="company_type" type="VARCHAR(50)"/>
            <column name="industry" type="VARCHAR(100)"/>
            <column name="main_products" type="TEXT"/>
            <column name="homepage" type="VARCHAR(255)"/>
            <column name="major_shareholder" type="VARCHAR(100)"/>
            <column name="created_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="updated_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>
        
        <rollback>
            <dropTable tableName="ipo_info"/>
        </rollback>
    </changeSet>

    <changeSet id="001-2" author="ipo-blog-system">
        <comment>Create financial_info table</comment>
        <createTable tableName="financial_info">
            <column name="id" type="INT" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="stock_code" type="VARCHAR(10)">
                <constraints nullable="false"/>
            </column>
            <column name="year" type="INT">
                <constraints nullable="false"/>
            </column>
            <column name="revenue" type="DECIMAL(15,2)"/>
            <column name="operating_profit" type="DECIMAL(15,2)"/>
            <column name="net_profit" type="DECIMAL(15,2)"/>
            <column name="total_debt" type="DECIMAL(15,2)"/>
            <column name="capital" type="DECIMAL(15,2)"/>
        </createTable>
        
        <addForeignKeyConstraint 
            baseTableName="financial_info"
            baseColumnNames="stock_code"
            constraintName="fk_financial_info_stock_code"
            referencedTableName="ipo_info"
            referencedColumnNames="stock_code"
            onDelete="CASCADE"/>
            
        <addUniqueConstraint
            tableName="financial_info"
            columnNames="stock_code,year"
            constraintName="unique_stock_year"/>
        
        <rollback>
            <dropTable tableName="financial_info"/>
        </rollback>
    </changeSet>

    <changeSet id="001-3" author="ipo-blog-system">
        <comment>Create offering_info table</comment>
        <createTable tableName="offering_info">
            <column name="id" type="INT" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="stock_code" type="VARCHAR(10)">
                <constraints nullable="false"/>
            </column>
            <column name="desired_price_min" type="INT"/>
            <column name="desired_price_max" type="INT"/>
            <column name="fixed_price" type="INT"/>
            <column name="underwriters" type="TEXT"/>
            <column name="total_competition_rate" type="DECIMAL(10,2)"/>
            <column name="institutional_competition_rate" type="DECIMAL(10,2)"/>
            <column name="retail_allocation" type="INT"/>
            <column name="institutional_allocation" type="INT"/>
            <column name="demand_forecast_date" type="DATE"/>
            <column name="subscription_date" type="DATE"/>
            <column name="payment_date" type="DATE"/>
            <column name="refund_date" type="DATE"/>
            <column name="listing_date" type="DATE"/>
        </createTable>
        
        <addForeignKeyConstraint 
            baseTableName="offering_info"
            baseColumnNames="stock_code"
            constraintName="fk_offering_info_stock_code"
            referencedTableName="ipo_info"
            referencedColumnNames="stock_code"
            onDelete="CASCADE"/>
        
        <rollback>
            <dropTable tableName="offering_info"/>
        </rollback>
    </changeSet>

    <changeSet id="001-4" author="ipo-blog-system">
        <comment>Create news_info table</comment>
        <createTable tableName="news_info">
            <column name="id" type="INT" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="stock_code" type="VARCHAR(10)">
                <constraints nullable="false"/>
            </column>
            <column name="title" type="VARCHAR(500)"/>
            <column name="url" type="VARCHAR(500)"/>
            <column name="source" type="VARCHAR(50)"/>
            <column name="published_date" type="DATETIME"/>
            <column name="summary" type="TEXT"/>
            <column name="sentiment" type="VARCHAR(20)"/>
            <column name="created_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>
        
        <addForeignKeyConstraint 
            baseTableName="news_info"
            baseColumnNames="stock_code"
            constraintName="fk_news_info_stock_code"
            referencedTableName="ipo_info"
            referencedColumnNames="stock_code"
            onDelete="CASCADE"/>
        
        <rollback>
            <dropTable tableName="news_info"/>
        </rollback>
    </changeSet>

    <changeSet id="001-5" author="ipo-blog-system">
        <comment>Create posting_history table</comment>
        <createTable tableName="posting_history">
            <column name="id" type="INT" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="stock_code" type="VARCHAR(10)">
                <constraints nullable="false"/>
            </column>
            <column name="file_path" type="VARCHAR(500)"/>
            <column name="created_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="status" type="VARCHAR(20)" defaultValue="completed"/>
        </createTable>
        
        <addForeignKeyConstraint 
            baseTableName="posting_history"
            baseColumnNames="stock_code"
            constraintName="fk_posting_history_stock_code"
            referencedTableName="ipo_info"
            referencedColumnNames="stock_code"
            onDelete="CASCADE"/>
        
        <rollback>
            <dropTable tableName="posting_history"/>
        </rollback>
    </changeSet>

</databaseChangeLog> 